name: CI

on:

  push:
  workflow_dispatch:

jobs:
  
  BuildAndTest:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v3

      - name: Build
        run: |
          chmod +x gradlew
          ./gradlew build

      - name: Unit Test
        run: |
          chmod +x gradlew
          ./gradlew jacocoTestCoverageVerification
      
      - name: SonarCloud Code Review
        run: |
          chmod +x gradlew
          ./gradlew sonar -Dsonar.token=${{ secrets.TOKEN_SONARCLOUD }}

      - name: SonarCloud Quality Gate check
        uses: sonarsource/sonarqube-quality-gate-action@master
        env:
          SONAR_TOKEN: ${{ secrets.TOKEN_SONARCLOUD }}
          SONAR_HOST_URL: https://sonarcloud.io
        with:
          scanMetadataReportFile: build/sonar/report-task.txt
      
      - uses: actions/upload-artifact@v3
        with:
          name: build
          path: ${{github.workspace}}/build/libs/testing-web-0.0.1-SNAPSHOT.jar'

  Deploy:
    runs-on: ubuntu-latest
    needs: BuildAndTest
    steps:
      - uses: actions/checkout@v3       

      - name: Login to GCR
        uses: docker/login-action@v3
        with:
              registry: gcr.io
              username: _json_key
              password: ${{ secrets.SA_GCP_CR }}

      - uses: actions/upload-artifact@v3
        with:
          name: build
      - name: Copia de Jar a Raiz de proyecto
        run: |
            cp testing-web-0.0.1-SNAPSHOT.jar .
            chmod 777 testing-web-0.0.1-SNAPSHOT.jar
        
      - name: Docker Build & Push
        run: | 
            docker build --tag gcr.io/suracrossit-2/testing-web:latest .
            docker push gcr.io/suracrossit-2/testing-web 
  
      - uses: 'google-github-actions/auth@v2'
        with:
          credentials_json: ${{ secrets.SA_GCP_CR }}
      
      - name: Create & Update Cloud Run With container in GCR - Deploy
        uses: 'google-github-actions/deploy-cloudrun@v2'
        with:
          image: 'gcr.io/suracrossit-2/testing-web'
          service: 'testing-web-mzoffoli'
  
#  Test:
#    runs-on: ubuntu-latest
#    steps:
#      - uses: actions/checkout@v3